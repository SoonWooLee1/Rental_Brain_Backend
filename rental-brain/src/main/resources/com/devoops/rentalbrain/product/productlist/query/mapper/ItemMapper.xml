<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.devoops.rentalbrain.product.productlist.query.mapper.ItemMapper">
    <resultMap id="getEachItemMap" type="com.devoops.rentalbrain.product.productlist.query.dto.EachItemDTO">
        <id property="id" column="ID"/>
        <result property="status" column="STATUS"/>
        <result property="firmName" column="FIRM_NAME"/>
        <result property="startDate" column="START_DATE"/>
        <result property="lastInspectDate" column="LAST_INSPECT_DATE"/>
    </resultMap>
    <select id="selectAllItems" resultMap="getEachItemMap" parameterType="string">
        SELECT
               A.ID,
               A.STATUS,
               E.NAME AS FIRM_NAME,
               C.START_DATE,
               A.LAST_INSPECT_DATE
          FROM item A
          LEFT JOIN contract_with_item B ON A.ID = B.ITEM_ID
          LEFT JOIN contract C ON B.CONTRACT_ID = C.ID AND C.STATUS = 'P'
          LEFT JOIN item_overdue D ON B.CONTRACT_ID = D.CONTRACT_ID AND D.STATUS = 'P'
          LEFT JOIN customer E ON (C.CUM_ID = E.ID OR D.CUM_ID = E.ID)
         WHERE A.NAME = #{itemName}
    </select>
    <resultMap id="getItemNameMap" type="com.devoops.rentalbrain.product.productlist.query.dto.ItemNameDTO">
        <result property="itemName" column="ITEM_NAME"/>
        <result property="categoryName" column="CATEGORY_NAME"/>
        <result property="monthlyPrice" column="MONTHLY_PRICE"/>
        <result property="stockAmount" column="STOCK_AMOUNT"/>
        <result property="rentalAmount" column="RENTAL_AMOUNT"/>
        <result property="possibleAmount" column="POSSIBLE_AMOUNT"/>
        <result property="repairAmount" column="REPAIR_AMOUNT"/>
        <result property="overdueAmount" column="OVERDUE_AMOUNT"/>
        <result property="wholeSales" column="WHOLE_SALES"/>
        <result property="wholeRepairCost" column="WHOLE_REPAIR_COST"/>
        <result property="utilizationRate" column="UTILIZATION_RATE"/>
    </resultMap>
    <select id="selectItemsByName" resultMap="getItemNameMap">
        SELECT
               A.ITEM_NAME,
               A.CATEGORY_NAME,
               A.MONTHLY_PRICE,
               SUM(A.ITEM_COUNT) AS STOCK_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'S'    THEN A.ITEM_COUNT ELSE 0 END) AS RENTAL_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'P'    THEN A.ITEM_COUNT ELSE 0 END) AS POSSIBLE_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'R'    THEN A.ITEM_COUNT ELSE 0 END) AS REPAIR_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'O'    THEN A.ITEM_COUNT ELSE 0 END) AS OVERDUE_AMOUNT,
               SUM(A.WHOLE_SALES) AS WHOLE_SALES,
               SUM(A.WHOLE_REPAIR_COST) AS WHOLE_REPAIR_COST,
               SUM(CASE WHEN A.STATUS = 'S'    THEN A.ITEM_COUNT ELSE 0 END)/SUM(A.ITEM_COUNT)*100 AS UTILIZATION_RATE
          FROM stocked_item A
         GROUP BY A.ITEM_NAME;
    </select>
    <select id="searchItemByName" resultMap="getItemNameMap" parameterType="string">
        SELECT
        A.ITEM_NAME,
        A.CATEGORY_NAME,
        A.MONTHLY_PRICE,
        SUM(A.ITEM_COUNT) AS STOCK_AMOUNT,
        SUM(CASE WHEN A.STATUS = 'S'    THEN A.ITEM_COUNT ELSE 0 END) AS RENTAL_AMOUNT,
        SUM(CASE WHEN A.STATUS = 'P'    THEN A.ITEM_COUNT ELSE 0 END) AS POSSIBLE_AMOUNT,
        SUM(CASE WHEN A.STATUS = 'R'    THEN A.ITEM_COUNT ELSE 0 END) AS REPAIR_AMOUNT,
        SUM(CASE WHEN A.STATUS = 'O'    THEN A.ITEM_COUNT ELSE 0 END) AS OVERDUE_AMOUNT,
        SUM(A.WHOLE_SALES) AS WHOLE_SALES,
        SUM(A.WHOLE_REPAIR_COST) AS WHOLE_REPAIR_COST,
        SUM(CASE WHEN A.STATUS = 'S'    THEN A.ITEM_COUNT ELSE 0 END)/SUM(A.ITEM_COUNT)*100 AS UTILIZATION_RATE
        FROM stocked_item A
        WHERE A.ITEM_NAME LIKE CONCAT('%', #{keyword}, '%')
        GROUP BY A.ITEM_NAME;
    </select>
    <resultMap id="getItemCountMap" type="com.devoops.rentalbrain.product.productlist.query.dto.ItemKpiDTO">
        <result property="wholeCount" column="WHOLE_COUNT"/>
        <result property="rentalCount" column="RENTAL_COUNT"/>
        <result property="repairCount" column="REPAIR_COUNT"/>
    </resultMap>
    <select id="countItems" resultMap="getItemCountMap">
        SELECT
               COUNT(*) AS WHOLE_COUNT,
               COUNT(CASE WHEN A.STATUS = 'S' THEN 1 END) AS RENTAL_COUNT,
               COUNT(CASE WHEN A.STATUS = 'S' THEN 1 END) AS REPAIR_COUNT
          FROM item A
    </select>
    <select id="countItemsList">
        SELECT
               COUNT(DISTINCT A.ITEM_NAME)
          FROM stocked_item A;
    </select>
    <select id="filteringItemsByCategory" resultMap="getItemNameMap" parameterType="string">
        SELECT
               A.ITEM_NAME,
               A.CATEGORY_NAME,
               A.MONTHLY_PRICE,
               SUM(A.ITEM_COUNT) AS STOCK_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'S'    THEN A.ITEM_COUNT ELSE 0 END) AS RENTAL_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'P'    THEN A.ITEM_COUNT ELSE 0 END) AS POSSIBLE_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'R'    THEN A.ITEM_COUNT ELSE 0 END) AS REPAIR_AMOUNT,
               SUM(CASE WHEN A.STATUS = 'O'    THEN A.ITEM_COUNT ELSE 0 END) AS OVERDUE_AMOUNT,
               SUM(A.WHOLE_SALES) AS WHOLE_SALES,
               SUM(A.WHOLE_REPAIR_COST) AS WHOLE_REPAIR_COST,
               SUM(CASE WHEN A.STATUS = 'S'    THEN A.ITEM_COUNT ELSE 0 END)/SUM(A.ITEM_COUNT)*100 AS UTILIZATION_RATE
          FROM stocked_item A
          LEFT JOIN item_category B ON A.CATEGORY_NAME = B.NAME
         WHERE B.NAME = #{categoryName}
         GROUP BY A.ITEM_NAME;
    </select>
    <select id="countSearchItemsList">
        SELECT
               COUNT(DISTINCT A.ITEM_NAME)
        FROM stocked_item A
        WHERE A.ITEM_NAME LIKE CONCAT('%', #{keyword}, '%')
    </select>
    <select id="countFilteringItemsList">
        SELECT
               COUNT(DISTINCT A.ITEM_NAME)
          FROM stocked_item A
          LEFT JOIN item_category B ON A.CATEGORY_NAME = B.NAME
         WHERE B.NAME = #{categoryName}
    </select>
</mapper>