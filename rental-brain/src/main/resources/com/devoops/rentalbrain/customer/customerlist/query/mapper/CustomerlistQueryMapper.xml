<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devoops.rentalbrain.customer.customerlist.query.mapper.CustomerlistQueryMapper">

    <resultMap id="CustomerKpiMap" type="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerKpiDTO">
        <result property="totalCustomers" column="totalCustomers"/>
        <result property="vipCustomers" column="vipCustomers"/>
        <result property="riskCustomers" column="riskCustomers"/>
        <result property="blacklistCustomers" column="blacklistCustomers"/>
    </resultMap>

    <resultMap id="CustomerMap" type="com.devoops.rentalbrain.customer.common.CustomerDTO">
        <id property="id" column="id"/>
        <result property="customerCode" column="customerCode"/>
        <result property="name" column="name"/>
        <result property="inCharge" column="inCharge"/>
        <result property="dept" column="dept"/>
        <result property="callNum" column="callNum"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="businessNum" column="businessNum"/>
        <result property="addr" column="addr"/>
        <result property="memo" column="memo"/>
        <result property="isDeleted" column="isDeleted"/>
        <result property="segmentName" column="segmentName"/>
        <result property="channelName" column="channelName"/>
        <result property="firstContractDate" column="firstContractDate"/>
        <result property="totalTransactionAmount" column="totalTransactionAmount"/>
        <result property="contractCount" column="contractCount"/>
    </resultMap>

    <resultMap id="CustomerDetailMap" type="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerDetailResponseDTO" extends="CustomerMap">
    </resultMap>

    <resultMap id="CustomerHistoryMap" type="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerHistoryDTO">
        <result property="type" column="type"/>
        <result property="content" column="content"/>
        <result property="date" column="date"/>
        <result property="performer" column="performer"/>
        <result property="status" column="status"/>
    </resultMap>

    <resultMap id="SupportListMap" type="com.devoops.rentalbrain.customer.customersupport.query.dto.CustomersupportDTO">
        <id property="id" column="id"/>
        <result property="customerSupportCode" column="customerSupportCode"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="status" column="status"/>
        <result property="createDate" column="createDate"/>
        <result property="action" column="action"/>
        <result property="categoryName" column="categoryName"/>
        <result property="channelName" column="channelName"/>
        <result property="empName" column="empName"/>
    </resultMap>

    <resultMap id="QuoteListMap" type="com.devoops.rentalbrain.business.quote.query.dto.QuoteQueryResponseDTO">
        <id property="quoteId" column="quoteId"/>
        <result property="quoteCode" column="quoteCode"/>
        <result property="quoteCounselingDate" column="quoteCounselingDate"/>
        <result property="quoteCounselor" column="quoteCounselor"/>
        <result property="quoteSummary" column="quoteSummary"/>
        <result property="channelName" column="channelName"/>
    </resultMap>

    <resultMap id="ContractListMap" type="com.devoops.rentalbrain.business.contract.query.dto.AllContractDTO">
        <id property="id" column="id"/>
        <result property="contractCode" column="contract_code"/>
        <result property="conName" column="conName"/>
        <result property="status" column="status"/>
        <result property="startDate" column="start_date"/>
        <result property="contractPeriod" column="contract_period"/>
        <result property="monthlyPayment" column="monthly_payment"/>
    </resultMap>

    <resultMap id="AsListMap" type="com.devoops.rentalbrain.product.maintenance.query.dto.AfterServiceDetailDTO">
        <id property="id" column="id"/>
        <result property="after_service_code" column="after_service_code"/>
        <result property="type" column="type"/>
        <result property="status" column="status"/>
        <result property="dueDate" column="dueDate"/>
        <result property="engineer" column="engineer"/>
        <result property="contents" column="contents"/>
    </resultMap>

    <resultMap id="FeedbackListMap" type="com.devoops.rentalbrain.customer.customersupport.query.dto.FeedbackDTO">
        <id property="id" column="id"/>
        <result property="feedbackCode" column="feedbackCode"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="star" column="star"/>
        <result property="createDate" column="createDate"/>
        <result property="action" column="action"/>
        <result property="categoryName" column="categoryName"/>
        <result property="channelName" column="channelName"/>
        <result property="empName" column="empName"/>
    </resultMap>

    <resultMap id="CouponListMap" type="com.devoops.rentalbrain.business.campaign.query.dto.CouponDTO">
        <result property="name" column="name"/>
        <result property="status" column="status"/>
        <result property="rate" column="rate"/>
        <result property="couponCode" column="couponCode"/>
    </resultMap>

    <resultMap id="PromotionListMap" type="com.devoops.rentalbrain.business.campaign.query.dto.PromotionDTO">
        <result property="name" column="name"/>
        <result property="status" column="status"/>
        <result property="promotionCode" column="promotionCode"/>
    </resultMap>

    <resultMap id="SegmentHistoryMap" type="com.devoops.rentalbrain.customer.customersegmenthistory.query.dto.HistoryQueryDTO">
        <id property="historyId" column="historyId"/>
        <result property="previousSegmentName" column="previousSegmentName"/>
        <result property="currentSegmentName" column="currentSegmentName"/>
        <result property="historyReason" column="historyReason"/>
        <result property="historyTriggerType" column="historyTriggerType"/>
        <result property="historyChangedAt" column="historyChangedAt"/>
    </resultMap>


    <select id="selectCustomerKpi" resultMap="CustomerKpiMap">
        SELECT
                (SELECT COUNT(*) FROM customer WHERE is_deleted = 'N') AS totalCustomers,
                (SELECT COUNT(*) FROM customer c JOIN segment s ON c.segment_id = s.id WHERE s.name = 'VIP 고객' AND c.is_deleted = 'N') AS vipCustomers,
                (SELECT COUNT(*) FROM customer c JOIN segment s ON c.segment_id = s.id WHERE s.name = '이탈 위험 고객' AND c.is_deleted = 'N') AS riskCustomers,
                (SELECT COUNT(*) FROM customer c JOIN segment s ON c.segment_id = s.id WHERE s.name = '블랙리스트 고객' AND c.is_deleted = 'N') AS blacklistCustomers
    </select>

    <select id="selectCustomerList" resultMap="CustomerMap">
        SELECT
        A.id,
        A.customer_code AS customerCode,
        A.name,
        A.in_charge AS inCharge,
        A.dept,
        A.call_num AS callNum,
        A.phone,
        A.email,
        A.business_num AS businessNum,
        A.addr,
        A.memo,
        A.is_deleted AS isDeleted,
        C.name AS segmentName,
        B.name AS channelName,
        (SELECT MIN(start_date) FROM contract WHERE cum_id = A.id) AS firstContractDate,
        COALESCE((SELECT SUM(total_amount) FROM contract WHERE cum_id = A.id), 0) AS totalTransactionAmount,
        (SELECT COUNT(*) FROM contract WHERE cum_id = A.id) AS contractCount
        FROM customer A
        LEFT JOIN channel B ON A.channel_id = B.id
        LEFT JOIN segment C ON A.segment_id = C.id
        <where>
            <choose>
                <when test="status == 'ACTIVE'">
                    AND A.is_deleted = 'N'
                </when>
                <when test="status == 'INACTIVE'">
                    AND A.is_deleted = 'Y'
                </when>
            </choose>
            <if test="name != null and name != ''">
                AND (A.name LIKE CONCAT('%', #{name}, '%') OR A.in_charge LIKE CONCAT('%', #{name}, '%'))
            </if>
            <if test="segments != null and segments.size > 0">
                AND C.name IN
                <foreach item="seg" collection="segments" open="(" separator="," close=")">
                    #{seg}
                </foreach>
            </if>
        </where>

        <choose>
            <when test="sortBy == 'id' and sortOrder == 'asc'">
                ORDER BY A.id ASC
            </when>
            <otherwise>
                ORDER BY A.id DESC
            </otherwise>
        </choose>

        LIMIT #{amount} OFFSET #{offset}
    </select>

    <select id="selectCustomerCount" resultType="long">
        SELECT COUNT(*)
        FROM customer A
        LEFT JOIN segment C ON A.segment_id = C.id
        <where>
            <choose>
                <when test="status == 'ACTIVE'">
                    AND A.is_deleted = 'N'
                </when>
                <when test="status == 'INACTIVE'">
                    AND A.is_deleted = 'Y'
                </when>
            </choose>
            <if test="name != null and name != ''">
                AND (A.name LIKE CONCAT('%', #{name}, '%') OR A.in_charge LIKE CONCAT('%', #{name}, '%'))
            </if>
            <if test="segments != null and segments.size > 0">
                AND C.name IN
                <foreach item="seg" collection="segments" open="(" separator="," close=")">
                    #{seg}
                </foreach>
            </if>
        </where>
    </select>

    <select id="selectCustomerDetail" resultMap="CustomerDetailMap">
        SELECT
            A.id,
            A.customer_code AS customerCode,
            A.name,
            A.in_charge AS inCharge,
            A.dept,
            A.call_num AS callNum,
            A.phone,
            A.email,
            A.business_num AS businessNum,
            A.addr,
            A.memo,
            A.is_deleted AS isDeleted,
            A.segment_id AS segmentId,
            C.name AS segmentName,
            B.name AS channelName,
            (SELECT MIN(start_date) FROM contract WHERE cum_id = A.id) AS firstContractDate,
            COALESCE((SELECT SUM(total_amount) FROM contract WHERE cum_id = A.id), 0) AS totalTransactionAmount,
            (SELECT COUNT(*) FROM contract WHERE cum_id = A.id) AS contractCount
        FROM customer A
                 LEFT JOIN segment C ON A.segment_id = C.id
                 LEFT JOIN channel B ON A.channel_id = B.id
        WHERE A.id = #{id}
    </select>

    <select id="selectCustomerHistory" resultMap="CustomerHistoryMap">
        SELECT type, content, date, performer, status
        FROM (
            SELECT '문의' AS type, title AS content, create_date AS date, (SELECT name FROM employee WHERE id = emp_id) AS performer, status FROM customer_support WHERE cum_id = #{customerId}
            UNION ALL
            SELECT '견적', summary, counseling_date, counselor, '완료' FROM quote WHERE cum_id = #{customerId}
            UNION ALL
            SELECT '계약', name, start_date, '', status FROM contract WHERE cum_id = #{customerId}
            UNION ALL
            SELECT 'AS/점검', contents, due_date, engineer, status FROM after_service WHERE cum_id = #{customerId}
            UNION ALL
            SELECT '피드백', title, create_date, (SELECT name FROM employee WHERE id = emp_id), CAST(star AS CHAR) FROM feedback WHERE cum_id = #{customerId}
            UNION ALL
            SELECT
            '세그먼트' AS type,
            CONCAT(PS.name, ' -> ', CS.name, ' (', H.reason, ')') AS content,
            H.changed_at AS date,
            'System' AS performer,
            H.trigger_type AS status
            FROM customer_segment_history H
            LEFT JOIN segment PS ON H.previous_segment_id = PS.id
            LEFT JOIN segment CS ON H.current_segment_id = CS.id
            WHERE H.customer_id = #{customerId}
            ) combined_history
        ORDER BY date DESC
            LIMIT #{amount} OFFSET #{offset}
    </select>

    <select id="selectSupportList" resultMap="SupportListMap">
        SELECT
            CS.id,
            CS.customer_support_code AS customerSupportCode,
            CS.title,
            CS.content,
            CS.status,
            CS.create_date AS createDate,
            CS.action,
            SC.name AS categoryName,
            CH.name AS channelName,
            E.name AS empName
        FROM customer_support CS
                 LEFT JOIN support_category SC ON CS.category_id = SC.id
                 LEFT JOIN channel CH ON CS.channel_id = CH.id
                 LEFT JOIN employee E ON CS.emp_id = E.id
        WHERE CS.cum_id = #{customerId}
        ORDER BY CS.create_date DESC
    </select>

    <select id="selectQuoteList" resultMap="QuoteListMap">
        SELECT
            Q.id AS quoteId,
            Q.quote_code AS quoteCode,
            Q.counseling_date AS quoteCounselingDate,
            Q.counselor AS quoteCounselor,
            Q.summary AS quoteSummary,
            CH.name AS channelName
        FROM quote Q
                 LEFT JOIN channel CH ON Q.channel_id = CH.id
        WHERE Q.cum_id = #{customerId}
        ORDER BY Q.counseling_date DESC
    </select>

    <select id="selectContractList" resultMap="ContractListMap">
        SELECT
            id,
            contract_code,
            name AS conName,
            status,
            start_date,
            contract_period,
            monthly_payment
        FROM contract
        WHERE cum_id = #{customerId}
        ORDER BY start_date DESC
    </select>

    <select id="selectAsList" resultMap="AsListMap">
        SELECT
            id,
            after_service_code,
            type,
            status,
            due_date AS dueDate,
            engineer,
            contents
        FROM after_service
        WHERE cum_id = #{customerId}
        ORDER BY due_date DESC
    </select>

    <select id="selectFeedbackList" resultMap="FeedbackListMap">
        SELECT
            F.id,
            F.feedback_code AS feedbackCode,
            F.title,
            F.content,
            F.star,
            F.create_date AS createDate,
            F.action,
            SC.name AS categoryName,
            CH.name AS channelName,
            E.name AS empName
        FROM feedback F
                 LEFT JOIN support_category SC ON F.category_id = SC.id
                 LEFT JOIN channel CH ON F.channel_id = CH.id
                 LEFT JOIN employee E ON F.emp_id = E.id
        WHERE F.cum_id = #{customerId}
        ORDER BY F.create_date DESC
    </select>

    <select id="selectCouponList" resultMap="CouponListMap">
        SELECT
            C.name,
            IC.is_used AS status,
            C.rate,
            C.coupon_code AS couponCode
        FROM issued_coupon IC
                 JOIN coupon C ON IC.coupon_id = C.id
        WHERE IC.cum_id = #{customerId}
    </select>

    <select id="selectPromotionList" resultMap="PromotionListMap">
        SELECT
            P.name,
            P.status,
            P.promotion_code AS promotionCode
        FROM promotion_log PL
                 JOIN promotion P ON PL.promotion_id = P.id
        WHERE PL.cum_id = #{customerId}
    </select>

    <select id="selectSegmentHistory" resultMap="SegmentHistoryMap">
        SELECT
            H.id AS historyId,
            PS.name AS previousSegmentName,
            CS.name AS currentSegmentName,
            H.reason AS historyReason,
            H.trigger_type AS historyTriggerType,
            H.changed_at AS historyChangedAt
        FROM customer_segment_history H
                 LEFT JOIN segment PS ON H.previous_segment_id = PS.id
                 LEFT JOIN segment CS ON H.current_segment_id = CS.id
        WHERE H.customer_id = #{customerId}
        ORDER BY H.changed_at DESC
    </select>

</mapper>