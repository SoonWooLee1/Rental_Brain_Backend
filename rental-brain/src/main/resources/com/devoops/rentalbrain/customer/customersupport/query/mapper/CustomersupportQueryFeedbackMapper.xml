<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.devoops.rentalbrain.customer.customersupport.query.mapper.CustomersupportQueryFeedbackMapper">

    <resultMap id="FeedbackResultMap" type="com.devoops.rentalbrain.customer.customersupport.query.dto.FeedbackDTO">
        <id property="id" column="id"/>
        <result property="feedbackCode" column="feedback_code"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="star" column="star"/>
        <result property="action" column="action"/>
        <result property="createDate" column="create_date_fmt"/>

        <result property="cumId" column="cum_id"/>
        <result property="customerName" column="customer_name"/>
        <result property="empId" column="emp_id"/>
        <result property="empName" column="emp_name"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="channelId" column="channel_id"/>
        <result property="channelName" column="channel_name"/>
    </resultMap>

    <select id="selectFeedbackList" resultMap="FeedbackResultMap">
        SELECT
        f.id,
        f.feedback_code,
        f.title,
        f.content,
        f.star,
        DATE_FORMAT(f.create_date, '%Y-%m-%d %H:%i:%s') as create_date_fmt,
        f.action,
        f.cum_id,
        c.customer_name,
        f.emp_id,
        e.name as emp_name,
        f.category_id,
        CASE
        WHEN f.category_id = 5 THEN '서비스 만족'
        WHEN f.category_id = 6 THEN '제품 불량'
        WHEN f.category_id = 7 THEN '제품 품질'
        WHEN f.category_id = 8 THEN 'AS 관련'
        ELSE '기타'
        END as category_name,
        f.channel_id,
        CASE
        WHEN f.channel_id = 1 THEN '전화'
        WHEN f.channel_id = 2 THEN '이메일'
        WHEN f.channel_id = 3 THEN '웹'
        WHEN f.channel_id = 4 THEN 'SNS'
        WHEN f.channel_id = 5 THEN '방문'
        ELSE '기타'
        END as channel_name
        FROM feedback f
        LEFT JOIN customer_list c ON f.cum_id = c.id
        LEFT JOIN employee e ON f.emp_id = e.id
        <where>
            <if test="keyword != null and keyword != ''">
                AND (f.title LIKE CONCAT('%', #{keyword}, '%')
                OR f.content LIKE CONCAT('%', #{keyword}, '%')
                OR c.customer_name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null">
                AND f.category_id = #{category}
            </if>
            <if test="status == 'C'">
                AND f.action IS NOT NULL AND f.action != ''
            </if>
            <if test="status == 'P'">
                AND (f.action IS NULL OR f.action = '')
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sortBy == 'id'">f.id ${sortOrder}</when>
            <when test="sortBy == 'star'">f.star ${sortOrder}</when>
            <when test="sortBy == 'feedbackCode'">f.feedback_code ${sortOrder}</when>
            <otherwise>f.id DESC</otherwise>
        </choose>
        LIMIT #{amount} OFFSET #{offset}
    </select>

    <select id="countFeedbackList" resultType="int">
        SELECT COUNT(*)
        FROM feedback f
        LEFT JOIN customer_list c ON f.cum_id = c.id
        <where>
            <if test="keyword != null and keyword != ''">
                AND (f.title LIKE CONCAT('%', #{keyword}, '%') OR c.customer_name LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="category != null">
                AND f.category_id = #{category}
            </if>
            <if test="status == 'C'">
                AND f.action IS NOT NULL AND f.action != ''
            </if>
            <if test="status == 'P'">
                AND (f.action IS NULL OR f.action = '')
            </if>
        </where>
    </select>

    <select id="selectFeedbackDetail" resultMap="FeedbackResultMap">
        SELECT
            f.id,
            f.feedback_code,
            f.title,
            f.content,
            f.star,
            DATE_FORMAT(f.create_date, '%Y-%m-%d %H:%i:%s') as create_date_fmt,
            f.action,
            f.cum_id,
            c.customer_name,
            f.emp_id,
            e.name as emp_name,
            f.category_id,
            CASE
                WHEN f.category_id = 5 THEN '서비스 만족'
                WHEN f.category_id = 6 THEN '제품 불량'
                WHEN f.category_id = 7 THEN '제품 품질'
                WHEN f.category_id = 8 THEN 'AS 관련'
                ELSE '기타'
                END as category_name,
            f.channel_id,
            CASE
                WHEN f.channel_id = 1 THEN '전화'
                WHEN f.channel_id = 2 THEN '이메일'
                WHEN f.channel_id = 3 THEN '웹'
                WHEN f.channel_id = 4 THEN 'SNS'
                WHEN f.channel_id = 5 THEN '방문'
                ELSE '기타'
                END as channel_name
        FROM feedback f
                 LEFT JOIN customer_list c ON f.cum_id = c.id
                 LEFT JOIN employee e ON f.emp_id = e.id
        WHERE f.id = #{id}
    </select>

    <select id="selectFeedbackKpi" resultType="java.util.Map">
        SELECT
            COUNT(*) as total,
            COUNT(CASE WHEN star &lt;= 2 THEN 1 END) as complaints
        FROM feedback
    </select>

</mapper>