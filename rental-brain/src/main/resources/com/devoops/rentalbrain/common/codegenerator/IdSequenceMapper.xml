<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  IdSequenceMapper
  비즈니스 코드(CUS-2025-001 등) 생성을 위한 채번 전용 Mapper

  전략:
  - (domain, year) 기준으로 시퀀스 관리
  - UPDATE + LAST_INSERT_ID() 패턴을 사용해
    동시성 환경에서도 안전하게 증가값을 가져온다.
-->
<mapper namespace="com.devoops.rentalbrain.common.codegenerator.IdSequenceMapper">

    <!--
      [1] 시퀀스 증가 처리

      - 해당 (domain, year) 행이 존재하면
        last_number를 +1 증가시킨다.
      - LAST_INSERT_ID(last_number + 1)을 사용해
        증가된 값을 현재 DB 커넥션에 저장한다.

      반환값:
      - 업데이트된 row 수
        · 1 : 정상적으로 증가됨
        · 0 : 해당 (domain, year) 시퀀스가 아직 없음
    -->
    <update id="incrementLastNumber">
        UPDATE id_sequence
        SET last_number = LAST_INSERT_ID(last_number + 1)
        WHERE domain = #{domain}
        AND year   = #{year}
    </update>

    <!--
      [2] 시퀀스 최초 생성

      - increment 시 대상 row가 없을 경우 호출
      - (domain, year) 기준으로 최초 row를 생성하며
        last_number는 1로 시작한다.

      주의:
      - 동시성 환경에서 이미 다른 트랜잭션이 먼저 INSERT 했을 수 있으므로
        Duplicate Key 예외는 상위 로직(CodeGenerator)에서 무시 처리한다.
    -->
    <insert id="insertFirst">
        INSERT INTO id_sequence (domain, year, last_number)
        VALUES (#{domain}, #{year}, 1)
    </insert>

    <!--
      [3] 증가된 시퀀스 값 조회

      - incrementLastNumber에서 설정한 LAST_INSERT_ID() 값을 조회
      - 반드시 같은 트랜잭션 / 같은 커넥션 안에서 호출되어야 한다.

      반환값:
      - 현재 생성된 시퀀스 번호 (예: 1, 2, 3 ...)
    -->
    <select id="selectLastInsertId" resultType="int">
        SELECT LAST_INSERT_ID()
    </select>

</mapper>
