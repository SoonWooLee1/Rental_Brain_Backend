<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devoops.rentalbrain.customer.customerlist.query.mapper.CustomerlistQueryMapper">

    <sql id="searchCriteria">
        WHERE A.is_deleted = 'N'
        <if test="dto.keyword != null and dto.keyword != ''">
            AND (
            A.name LIKE CONCAT('%', #{dto.keyword}, '%') OR
            A.in_charge LIKE CONCAT('%', #{dto.keyword}, '%') OR
            REPLACE(A.call_num, '-', '') LIKE CONCAT('%', #{dto.keyword}, '%') OR
            REPLACE(A.phone, '-', '') LIKE CONCAT('%', #{dto.keyword}, '%') OR
            REPLACE(A.business_num, '-', '') LIKE CONCAT('%', #{dto.keyword}, '%')
            )
        </if>
        <if test="dto.segments != null and dto.segments.size() > 0">
            AND (
            <foreach collection="dto.segments" item="seg" separator=" OR ">
                C.name LIKE CONCAT('%', #{seg}, '%')
            </foreach>
            )
        </if>
    </sql>

    <select id="selectCustomerList" resultType="com.devoops.rentalbrain.customer.common.CustomerDTO">
        SELECT
               A.id
             , A.customer_code
             , A.name
             , A.in_charge
             , A.dept
             , A.call_num
             , A.phone
             , A.email
             , A.business_num
             , A.addr
             , A.last_transaction
             , A.first_contract_date
             , A.memo
             , A.star
             , A.is_deleted
             , B.name AS channel_name
             , C.name AS segment_name
             , (SELECT COUNT(*) FROM contract WHERE cum_id = A.id) AS contract_count
             , (SELECT COALESCE(SUM(total_amount), 0) FROM contract WHERE cum_id = A.id) AS total_transaction_amount
             , (SELECT MAX(start_date) FROM contract WHERE cum_id = A.id) AS recent_rental_date
          FROM customer A
          LEFT JOIN channel B ON A.channel_id = B.id
          LEFT JOIN segment C ON A.segment_id = C.id
        <include refid="searchCriteria"/>
         ORDER BY A.id DESC
         LIMIT #{dto.amount} OFFSET #{dto.offset}
    </select>

    <select id="countCustomer" resultType="int">
        SELECT COUNT(*)
          FROM customer A
          LEFT JOIN channel B ON A.channel_id = B.id
          LEFT JOIN segment C ON A.segment_id = C.id
        <include refid="searchCriteria"/>
    </select>

    <select id="selectKpi" resultType="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerKpiDTO">
        SELECT
              COUNT(*) as totalCount,
              COUNT(CASE WHEN C.name LIKE '%VIP%' THEN 1 END) as vipCount,
              COUNT(CASE WHEN C.name LIKE '%위험%' OR C.name LIKE '%이탈%' THEN 1 END) as riskCount,
              COUNT(CASE WHEN C.name LIKE '%블랙%' THEN 1 END) as blacklistCount,
              (COUNT(CASE WHEN C.name LIKE '%VIP%' THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0)) as vipRate
          FROM customer A
          LEFT JOIN channel B ON A.channel_id = B.id
          LEFT JOIN segment C ON A.segment_id = C.id
         WHERE A.is_deleted = 'N'
    </select>

    <resultMap id="CustomerDetailMap" type="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerDetailResponseDTO">
        <id property="id" column="id"/>
        <result property="customerCode" column="customer_code"/>
        <result property="name" column="name"/>
        <result property="inCharge" column="in_charge"/>
        <result property="dept" column="dept"/>
        <result property="callNum" column="call_num"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="businessNum" column="business_num"/>
        <result property="addr" column="addr"/>
        <result property="memo" column="memo"/>
        <result property="segmentName" column="segment_name"/>
        <result property="channelName" column="channel_name"/>
        <result property="lastTransaction" column="last_transaction"/>
        <result property="firstContractDate" column="first_contract_date"/>

        <result property="contractCount" column="contract_count"/>
        <result property="totalTransactionAmount" column="total_transaction_amount"/>
        <result property="recentRentalDate" column="recent_rental_date"/>

        <collection property="contractList" column="id" select="selectContractsByCustomerId"/>
        <collection property="supportList" column="id" select="selectSupportsByCustomerId"/>
        <collection property="asList" column="id" select="selectAsByCustomerId"/>
        <collection property="quoteList" column="id" select="selectQuotesByCustomerId"/>
        <collection property="feedbackList" column="id" select="selectFeedbacksByCustomerId"/>
    </resultMap>

    <select id="selectCustomerDetail" resultMap="CustomerDetailMap">
        SELECT
               A.*
             , B.name AS channel_name
             , C.name AS segment_name
             , (SELECT COUNT(*) FROM contract WHERE cum_id = A.id) AS contract_count
             , (SELECT COALESCE(SUM(total_amount), 0) FROM contract WHERE cum_id = A.id) AS total_transaction_amount
             , (SELECT MAX(start_date) FROM contract WHERE cum_id = A.id) AS recent_rental_date
          FROM customer A
          LEFT JOIN channel B ON A.channel_id = B.id
          LEFT JOIN segment C ON A.segment_id = C.id
         WHERE A.id = #{id}
    </select>

    <select id="selectSupportsByCustomerId" resultType="com.devoops.rentalbrain.customer.customersupport.command.dto.CustomersupportDTO">
        SELECT * FROM customer_support WHERE cum_id = #{id} ORDER BY create_date DESC
    </select>

    <select id="selectContractsByCustomerId" resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractSummaryDTO">
        SELECT * FROM contract WHERE cum_id = #{id} ORDER BY start_date DESC
    </select>

    <select id="selectAsByCustomerId" resultType="com.devoops.rentalbrain.product.maintenance.query.dto.AfterServiceDTO">
        SELECT * FROM after_service WHERE cum_id = #{id} ORDER BY due_date DESC
    </select>

    <select id="selectQuotesByCustomerId" resultType="map">
        SELECT * FROM quote
         WHERE cum_id = #{id}
         ORDER BY counseling_date DESC
    </select>

    <select id="selectFeedbacksByCustomerId" resultType="map">
        SELECT * FROM feedback
         WHERE cum_id = #{id}
         ORDER BY create_date DESC
    </select>

</mapper>