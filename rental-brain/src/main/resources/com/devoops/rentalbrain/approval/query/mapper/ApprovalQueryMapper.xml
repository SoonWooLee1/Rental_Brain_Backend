<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.devoops.rentalbrain.approval.query.mapper.ApprovalQueryMapper">
    <select id="getApprovalStatus"
            parameterType="long"
            resultType="com.devoops.rentalbrain.approval.query.dto.ApprovalStatusDTO">
        SELECT
            -- 개인 승인 상태
            SUM(CASE WHEN emp_id = #{empId} AND is_approved = 'Y' THEN 1 ELSE 0 END) AS my_approved,
            SUM(CASE WHEN emp_id = #{empId} AND is_approved = 'N' THEN 1 ELSE 0 END) AS my_rejected,
            SUM(CASE WHEN emp_id = #{empId} AND is_approved = 'U' THEN 1 ELSE 0 END) AS my_pending,

            -- 전체 승인 상태
            SUM(CASE
                    WHEN approval_id IN (
                        SELECT approval_id
                        FROM approval_mapping
                        GROUP BY approval_id
                        HAVING SUM(CASE WHEN is_approved != 'Y' THEN 1 ELSE 0 END) = 0
                    )
                        THEN 1 ELSE 0
                END) AS fully_approved_count,

            SUM(CASE
                    WHEN approval_id IN (
                        SELECT approval_id
                        FROM approval_mapping
                        GROUP BY approval_id
                        HAVING SUM(CASE WHEN is_approved != 'Y' THEN 1 ELSE 0 END) > 0
                    )
                        THEN 1 ELSE 0
                END) AS not_fully_approved_count
        FROM approval_mapping
        WHERE emp_id = #{empId}
    </select>

    <select id="selectPendingApprovalsByEmpIdWithPaging"
            parameterType="map"
            resultType="com.devoops.rentalbrain.approval.query.dto.PendingApprovalDTO">

        SELECT
        approval_mapping_id   AS approvalMappingId,
        approver_emp_id       AS approverEmpId,
        approval_step         AS approvalStep,
        is_approved           AS isApproved,
        approval_code         AS approvalCode,
        approval_title        AS approvalTitle,
        request_date          AS requestDate,
        request_emp_id        AS requestEmpId,
        employee_code         AS employeeCode,
        employee_name         AS employeeName,
        position_name         AS positionName
        FROM v_approval_payment_manage
        WHERE approver_emp_id = #{empId}
        AND is_approved = 'U'

        <if test="criteria.keyword != null and criteria.keyword != ''">
            AND (
            approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
            OR approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
            )
        </if>

        ORDER BY request_date DESC
        LIMIT #{criteria.amount}
        OFFSET #{criteria.offset}

    </select>
    <select id="countPendingApprovalsByEmpId"
            parameterType="map"
            resultType="long">

        SELECT COUNT(*)
        FROM v_approval_payment_manage
        WHERE approver_emp_id = #{empId}
        AND is_approved = 'U'

        <if test="criteria.keyword != null and criteria.keyword != ''">
            AND (
            approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
            OR approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
            )
        </if>
    </select>
    <select id="selectInProgressApprovals"
            parameterType="map"
            resultType="com.devoops.rentalbrain.approval.query.dto.ApprovalProgressDTO">

        SELECT
        approval_code,
        approval_title,
        MIN(request_date) AS requestDate,

        /* 진행률 */
        COUNT(*) AS totalStep,
        SUM(CASE WHEN is_approved = 'Y' THEN 1 ELSE 0 END) AS approvedStep,
        ROUND(
        SUM(CASE WHEN is_approved = 'Y' THEN 1 ELSE 0 END)
        / COUNT(*) * 100
        ) AS progressRate,

        /* 다음 승인자 */
        MAX(
        CASE
        WHEN is_approved = 'U'
        AND approval_step = (
        SELECT MIN(approval_step)
        FROM v_approval_payment_manage sub
        WHERE sub.approval_code = v.approval_code
        AND sub.is_approved = 'U'
        )
        THEN approver_name
        END
        ) AS nextApproverName,

        MAX(
        CASE
        WHEN is_approved = 'U'
        AND approval_step = (
        SELECT MIN(approval_step)
        FROM v_approval_payment_manage sub
        WHERE sub.approval_code = v.approval_code
        AND sub.is_approved = 'U'
        )
        THEN approver_position_name
        END
        ) AS nextApproverPosition

        FROM v_approval_payment_manage v
        WHERE approval_code IN (
        SELECT approval_code
        FROM v_approval_payment_manage
        WHERE approver_emp_id = #{empId}
        )
        AND approval_status = 'P'

        <!--
         검색 조건 -->
        <if test="criteria.keyword != null and criteria.keyword != ''">
            AND (
            approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
            OR approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
            )
        </if>

        GROUP BY approval_code, approval_title
        ORDER BY requestDate DESC
        LIMIT #{criteria.amount}
        OFFSET #{criteria.offset}

    </select>
    <select id="countInProgressApprovals"
            parameterType="map"
            resultType="long">

        SELECT COUNT(DISTINCT approval_code)
        FROM v_approval_payment_manage
        WHERE approval_code IN (
        SELECT approval_code
        FROM v_approval_payment_manage
        WHERE approver_emp_id = #{empId}
        )
        AND approval_status = 'P'

        <if test="criteria.keyword != null and criteria.keyword != ''">
            AND (
            approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
            OR approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
            )
        </if>
    </select>
    <select id="selectCompletedApprovals"
            parameterType="map"
            resultType="com.devoops.rentalbrain.approval.query.dto.ApprovalCompletedDTO">

        SELECT
        v.approval_code        AS approvalCode,
        v.approval_title       AS approvalTitle,

        MIN(v.request_date)    AS requestDate,
        MAX(v.approval_date)   AS lastProcessDate,

        v.reject_reason        AS rejectReason,
        /* 결과 상태 */
        CASE
        WHEN SUM(CASE WHEN v.is_approved IN ('N','R') THEN 1 ELSE 0 END) > 0
        THEN 'REJECTED'
        ELSE 'APPROVED'
        END AS resultStatus

        FROM v_approval_payment_manage v

        <where>
            <!-- 로그인 사용자 기준 -->
            v.approver_emp_id = #{empId}

            <!-- ✅ 완료 조건 -->
            AND (
            /* 1️⃣ 거절이 하나라도 있으면 완료 */
            EXISTS (
            SELECT 1
            FROM v_approval_payment_manage sub
            WHERE sub.approval_code = v.approval_code
            AND sub.is_approved IN ('N','R')
            )
            OR
            /* 2️⃣ 미처리(U)가 하나도 없으면 완료 */
            NOT EXISTS (
            SELECT 1
            FROM v_approval_payment_manage sub
            WHERE sub.approval_code = v.approval_code
            AND sub.is_approved = 'U'
            )
            )

            <!-- 검색 -->
            <if test="criteria.keyword != null and criteria.keyword != ''">
                <choose>
                    <when test="criteria.type == 'code'">
                        AND v.approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
                    </when>
                    <when test="criteria.type == 'title'">
                        AND v.approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
                    </when>
                    <otherwise>
                        AND (
                        v.approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
                        OR v.approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>

        GROUP BY v.approval_code, v.approval_title
        ORDER BY lastProcessDate DESC
        LIMIT #{criteria.amount}
        OFFSET #{criteria.offset}

    </select>
    <select id="countCompletedApprovals"
            parameterType="map"
            resultType="long">

        SELECT COUNT(*)
        FROM (
        SELECT v.approval_code
        FROM v_approval_payment_manage v

        <where>
            v.approver_emp_id = #{empId}

            AND (
            EXISTS (
            SELECT 1
            FROM v_approval_payment_manage sub
            WHERE sub.approval_code = v.approval_code
            AND sub.is_approved IN ('N','R')
            )
            OR
            NOT EXISTS (
            SELECT 1
            FROM v_approval_payment_manage sub
            WHERE sub.approval_code = v.approval_code
            AND sub.is_approved = 'U'
            )
            )

            <if test="criteria.keyword != null and criteria.keyword != ''">
                <choose>
                    <when test="criteria.type == 'code'">
                        AND v.approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
                    </when>
                    <when test="criteria.type == 'title'">
                        AND v.approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
                    </when>
                    <otherwise>
                        AND (
                        v.approval_code LIKE CONCAT('%', #{criteria.keyword}, '%')
                        OR v.approval_title LIKE CONCAT('%', #{criteria.keyword}, '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>

        GROUP BY v.approval_code
        ) completed
    </select>


</mapper>