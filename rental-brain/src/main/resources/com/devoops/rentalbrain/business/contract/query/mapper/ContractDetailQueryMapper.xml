<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.devoops.rentalbrain.business.contract.query.mapper.ContractDetailQueryMapper">
    <!-- =========================
        계약 개요
        ========================= -->
    <select id="selectContractOverview"
            parameterType="long"
            resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractOverviewDTO">
        SELECT
            c.id                AS contractId,
            c.contract_code     AS contractCode,
            c.name              AS contractName,
            c.start_date        AS startDate,
            c.contract_period   AS contractPeriod,
            c.monthly_payment   AS monthlyPayment,
            c.total_amount      AS totalAmount,
            c.pay_method        AS payMethod,
            c.special_content   AS specialContent,
            c.status            AS contractStatus,

            t.id                AS customerId,
            t.customer_code     AS customerCode,
            t.name              AS customerName,
            t.in_charge         AS inCharge,
            t.call_num          AS callNum
        FROM contract c
                 LEFT JOIN customer t ON c.cum_id = t.id
        WHERE c.id = #{contractId}
    </select>

    <!-- =========================
         계약 수납 연체 건수
         ========================= -->
    <select id="countOverduePayments"
            parameterType="long"
            resultType="int">
        SELECT
            COUNT(*) AS nCount
        FROM payment_details
        WHERE con_id = #{contractId}
          AND payment_status = 'N'
    </select>

    <!-- =========================
         계약 진행률
         ========================= -->
    <select id="selectContractProgress"
            parameterType="long"
            resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractProgressDTO">
        SELECT
            id AS contractId,
            start_date AS startDate,
            contract_period AS contractPeriod,
            CASE
                WHEN <![CDATA[ NOW() < start_date ]]> THEN 0

                WHEN <![CDATA[
                NOW() >= DATE_ADD(start_date, INTERVAL contract_period MONTH)
            ]]> THEN 100

                ELSE
                    ROUND(
                            TIMESTAMPDIFF(MONTH, start_date, NOW())
                                / contract_period * 100
                    )
                END AS progressRate
        FROM contract
        WHERE id = #{contractId}
    </select>

    <!-- =========================
         렌탈 자산 개수
         ========================= -->
    <select id="countContractProducts"
            parameterType="long"
            resultType="int">
        SELECT
            COUNT(*) AS productCount
        FROM contract_with_item
        WHERE contract_id = #{contractId}
    </select>

    <!-- =========================
         아이템 목록 조회 (이름 + 수량)
         ========================= -->
    <select id="selectContractItemSummary"
            parameterType="long"
            resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractItemSummaryDTO">
        SELECT
            i.name AS itemName,
            COUNT(cwi.id) AS quantity
        FROM contract_with_item cwi
                RIGHT JOIN item i ON cwi.item_id = i.id
        WHERE cwi.contract_id = #{contractId}
        GROUP BY i.name
    </select>

    <!-- =========================
         아이템 상세 조회
         ========================= -->
    <select id="selectContractItemDetails"
            parameterType="long"
            resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractItemDetailDTO">
        SELECT
            i.id                AS itemId,
            i.item_code         AS itemCode,
            i.name              AS name,
            i.last_inspect_date AS latelyInspectDate
        FROM contract_with_item cwi
                 RIGHT JOIN item i ON cwi.item_id = i.id
        WHERE cwi.contract_id = #{contractId}
    </select>
    <!-- =========================
         계약 결제 내역 조회
         ========================= -->
    <select id="selectContractPaymentDetail"
            parameterType="long"
            resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractPaymentDTO">
        SELECT id,
               payment_due AS paymentDue,
               payment_actual AS paymentActual,
               overdue_days AS overdueDays,
               payment_status AS paymentStatus,
               con_id AS conId
        FROM payment_details
        WHERE con_id = #{contractId}
    </select>
</mapper>